knitr::opts_chunk$set(echo = TRUE)
library(hrbrthemes)
library(prettydoc)
library(pacman)
p_load("quantmod","stringr","forecast","tseries","janitor",
"formattable","data.table","gt","DT","scales","tibble",
"ggplot2","plotly","GGally","openxlsx","readxl","dplyr","tidyr","lubridate")
dw<-getSymbols("^DJI",from="2020-01-01")
dw <-rownames_to_column(data.frame( DJI)) %>% select(c(1,7)) %>%
rename(date=rowname,price=DJI.Adjusted) %>%
mutate(date=ymd(date)) %>%
mutate(wk=round_date(date,"week"),mn=round_date(date,"month")) %>% arrange(date)
# monthly
mns<-dw %>% group_by(mn) %>% summarize(prices=mean(price),.groups = "drop")
#last
mnlts<-ts(mns$prices,start = c(2020,1),end =c(2023,9) ,frequency = 12)
mnlets<-ets(mnlts)
mnlf<-forecast(mnlets,h = 12)
mn_last_model<-
cbind(
mns[c(46:57),] ,
rowid_to_column(as.data.frame(mnlf)) %>% clean_names() %>% select(4)
) %>%rename(date=mn) %>% mutate(variance=round((hi_80/prices)-1,2))
mn_last_model_gt<-
mn_last_model %>% gt() %>% cols_label_with(columns = everything(),fn = toupper) %>% tab_header(title = "DowJones index Last Year Prices.",subtitle = "Period: Oct 2023 - Sep 2024") %>% opt_stylize(style = 2) %>% tab_row_group(label = "2023",rows = date<="2023-12-31",id = "2023") %>%tab_row_group(label = "2024",rows = date>="2024-01-01" & date<="2024-12-31",id = "2024")  %>% row_group_order(groups = c("2023","2024")) %>% tab_style(style =list(cell_text(align = "left",weight = "bold"),cell_fill(color="gray")) ,locations = cells_row_groups()) %>% tab_style(style =list(cell_text(align = "center",weight = "bold")) ,locations = cells_body()) %>% tab_style(style =list(cell_text(align = "center",weight = "bold")) ,locations = cells_column_labels()) %>% summary_rows(groups = everything(),columns =c(2:4) ,fns = list(Mean=~mean(.))) %>% tab_style(style =list(cell_text(align = "center",weight = "bold"),cell_fill(color="#FCDE70")) ,locations = cells_summary()) %>% tab_style(style =list(cell_text(align = "center",weight = "bold"),cell_fill(color="#FCDE70")) ,locations = cells_stub_summary()) %>% tab_style(style =list(cell_text(align = "center",weight = "bold"),cell_fill(color="#FCDE70")) ,locations = cells_title())
months_last_chart<-
mn_last_model %>% select(c(date,prices,hi_80))%>% mutate(date=as.POSIXct(date)) %>%
pivot_longer(!date,names_to ="cat" ,values_to = "prices") %>%
ggplot(aes(x=date,y=prices,color=cat,group=cat))+geom_line(size=1)+
scale_x_datetime(date_breaks ="month" ,date_labels = "%b-%Y")+
scale_y_continuous(labels = comma)+labs(x="",y="")+
theme_bw()+theme(axis.text.x =
element_text(size=9,color="black",face = "bold"),axis.text.y =
element_text(size=9,color="black",face = "bold"))+scale_fill_brewer(palette = "Set1")
# months next
mnts<-ts(mns$prices,start =c(2020,1),
end = c(2024,9),frequency = 12)
mnets<-ets(mnts)
mnar<-auto.arima(mnts)
mnf<-forecast(mnar,h = 18)
mnfe<-forecast(mnets,h = 18)
months_next_chart<-
rbind(mns %>% rename(date=mn) %>% mutate(point_forecast="",lo_80="",hi_80=""),
cbind(
data.frame(date=seq(as.Date("2024-10-01"),len=18,by="month"))
,rownames_to_column(data.frame(mnfe)) %>% select(c(2,3,4)) %>% clean_names()) %>%
mutate(prices="") %>% select(1,2,3,4,5)) %>%
mutate(prices=round(as.numeric(prices,2)),
hi_80=round(as.numeric(hi_80),2),lo_80=round(as.numeric(lo_80),2),
point_forecast=round(as.numeric( point_forecast),2)) %>%
mutate(date=as.POSIXct(date),point_forecast=lead(point_forecast,2),hi_80=lead(hi_80,3),lo_80=lead(lo_80,2)) %>%
filter(! is.na(date)) %>%
pivot_longer(!date,names_to ="cat",values_to ="values") %>%
ggplot()+
geom_line(aes(x=date,y=values,color=cat,group=cat),size=1.3)+
scale_y_continuous(limits =   c(20000,50000))+theme_bw()+
theme(axis.text.x =
element_text(size=9,color="black",face = "bold"),axis.text.y =
element_text(size=9,color="black",face = "bold"))+
labs(x="",y="")
months_next_gt<-
cbind(data.frame(date=seq(as.Date("2024-10-01"),len=18,by="month"))
,rownames_to_column(data.frame(mnfe)) %>% select(c(2,3,4)) %>% clean_names()
) %>% mutate(prices="") %>% select(1,2,3,4) %>% gt() %>%
tab_row_group(rows = date>="2024-10-1" & date<="2024-12-01",label = "2024",id="2024") %>%
tab_row_group(rows = date>="2025-1-1" & date<="2025-12-01",label = "2025",id="2025") %>%
tab_row_group(rows = date>="2026-1-1" ,label = "2026",id ="2026") %>% row_group_order(groups = c("2024","2025","2026")) %>%
tab_header(title = "Forecast DowJones Index",subtitle = "Period: 18 Months Next.") %>%
tab_stubhead(label = "Years") %>% cols_label_with(columns = everything(),fn = toupper) %>%
tab_style(style =cell_text(align = "center",weight = "bold") ,locations = cells_body()) %>%
fmt_number(columns = c(2:4),decimals = 2) %>% fmt_date(columns = 1,date_style = "yMMM") %>%
tab_style(style =list(cell_text(weight = "bold"),cell_fill("gray")) ,locations = cells_row_groups()) %>%
opt_stylize(style = 3) %>% tab_style(style =list(cell_text(weight = "bold")) ,locations = cells_column_labels()) %>%
tab_style(style = list(cell_text(weight = "bold"),cell_fill("#D8A25E")),locations = cells_title()) %>%
summary_rows(groups = everything(),fns =list(Mean=~mean(.)),columns = c(3,4)) %>%
tab_style(style = list(cell_text(weight = "bold"),cell_fill("#FCDE70")),
locations = cells_summary()) %>%
tab_style(style = list(cell_text(weight = "bold"),cell_fill("#FCDE70")),locations = cells_stub_summary())
autoplot(decompose(diff(mnlts)))
ggplotly( months_last_chart , width=900)
mn_last_model_gt
autoplot(decompose(diff(mnts)))
ggplotly( months_next_chart,900)
months_next_gt
